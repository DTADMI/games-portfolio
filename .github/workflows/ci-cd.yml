# .github/workflows/ci-cd.yml
name: CI/CD Pipeline (Bun + Maven)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  SPRING_PROFILES_ACTIVE: ci
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  # Artifact Registry repository name (create it once in your project)
  AR_REPO: ${{ vars.AR_REPO || 'games' }}
  BACKEND_SERVICE: ${{ vars.BACKEND_SERVICE || 'games-backend' }}
  FRONTEND_SERVICE: ${{ vars.FRONTEND_SERVICE || 'games-frontend' }}

jobs:
  test-backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build & Test (Maven)
        working-directory: backend
        run: mvn -U -B -DskipTests=false verify

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (monorepo)
        run: bun install --frozen-lockfile

      - name: Lint (frontend)
        run: bun --cwd frontend run lint:ci

      - name: Test (frontend)
        run: bun --cwd frontend test

      - name: Build (frontend)
        run: bun --cwd frontend build

  build-and-push:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set env flags for Docker Hub
        id: hubflags
        run: |
          if [ -n "${{ vars.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "has_hub=true" >> $GITHUB_OUTPUT
          else
            echo "has_hub=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}

      - name: Build and push backend
        uses: docker/build-push-action@v4
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/games-backend:latest

      - name: Build and push frontend
        uses: docker/build-push-action@v4
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}
        with:
          context: .
          file: ./frontend/Dockerfile.monorepo
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/games-frontend:latest

  deploy-cloudrun:
    needs: [ test-backend, test-frontend ]
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4

      - name: Set flags for GCP deploy
        id: gcpflags
        run: |
          if [ -n "${{ secrets.GCP_PROJECT_ID }}" ] && [ -n "${{ secrets.GCP_REGION }}" ] && [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "can_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "can_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use gcloud as a credential helper
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Compute image tags
        id: tags
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          SHA=${GITHUB_SHA::12}
          echo "backend=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.BACKEND_SERVICE }}:${SHA}" >> $GITHUB_OUTPUT
          echo "frontend=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.FRONTEND_SERVICE }}:${SHA}" >> $GITHUB_OUTPUT

      - name: Build & push backend image to Artifact Registry
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          docker build -t ${{ steps.tags.outputs.backend }} -f backend/Dockerfile .
          docker push ${{ steps.tags.outputs.backend }}

      - name: Build & push frontend image to Artifact Registry
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          docker build -t ${{ steps.tags.outputs.frontend }} -f frontend/Dockerfile.monorepo .
          docker push ${{ steps.tags.outputs.frontend }}

      - name: Deploy backend to Cloud Run (image)
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --region="${{ secrets.GCP_REGION }}" \
            --image=${{ steps.tags.outputs.backend }} \
            --allow-unauthenticated \
            --port=3000 \
            --set-env-vars SPRING_PROFILES_ACTIVE=prod \
            --add-cloudsql-instances "${{ vars.GCP_INSTANCE_CONNECTION_NAME || secrets.GCP_INSTANCE_CONNECTION_NAME }}" \
            --set-secrets "SPRING_DATASOURCE_URL=SPRING_DATASOURCE_URL:latest,SPRING_DATASOURCE_USERNAME=SPRING_DATASOURCE_USERNAME:latest,SPRING_DATASOURCE_PASSWORD=SPRING_DATASOURCE_PASSWORD:latest"

      - name: Deploy frontend to Cloud Run (image)
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --region="${{ secrets.GCP_REGION }}" \
            --image=${{ steps.tags.outputs.frontend }} \
            --allow-unauthenticated \
            --port=8080 \
            --set-env-vars NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL || 'https://games-backend-245231653364.northamerica-northeast1.run.app/api' }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Compute SSH deploy flags
        id: sshflags
        run: |
          if [ -n "${{ secrets.PRODUCTION_HOST }}" ] && [ -n "${{ secrets.PRODUCTION_USER }}" ] && [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "can_ssh=true" >> $GITHUB_OUTPUT
          else
            echo "can_ssh=false" >> $GITHUB_OUTPUT
          fi
      - name: Deploy to production
        uses: appleboy/ssh-action@master
        if: ${{ github.ref == 'refs/heads/main' && steps.sshflags.outputs.can_ssh == 'true' }}
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/games
            docker-compose pull
            docker-compose up -d
            docker system prune -f
